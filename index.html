<script>
    // Direct link to your alerts.json file
    const GITHUB_DATA_URL = 'https://raw.githubusercontent.com/carry100/canarytrap-dashboard/main/alerts.json';

    async function loadAlerts() {
        try {
            // Use a CORS proxy to avoid browser restrictions
            const corsProxy = "https://api.allorigins.win/raw?url=";
            const response = await fetch(corsProxy + encodeURIComponent(GITHUB_DATA_URL));
            
            if (!response.ok) {
                throw new Error(`Network error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const alerts = data.alerts || [];
            const tableBody = document.getElementById('alertsTableBody');

            // Update stats
            document.getElementById('totalAlerts').textContent = alerts.length;
            
            const uniqueIPs = new Set(alerts.map(alert => alert.sourceIP));
            document.getElementById('uniqueIPs').textContent = uniqueIPs.size;
            
            if (alerts.length > 0) {
                const lastAlert = new Date(alerts[alerts.length-1].timestamp);
                document.getElementById('lastTrigger').textContent = lastAlert.toLocaleTimeString();
            }

            if (alerts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="has-text-centered">No alerts detected. Traps are active and monitoring.</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            alerts.reverse().forEach((alert, index) => {
                const isRecent = index === 0;
                const row = document.createElement('tr');
                if (isRecent) row.classList.add('last-trigger');
                
                row.innerHTML = `
                    <td>${new Date(alert.timestamp).toLocaleString()}</td>
                    <td><code class="console-text">${alert.token}</code></td>
                    <td><span class="tag is-dark">${alert.sourceIP}</span></td>
                    <td><span class="has-text-muted">${alert.userAgent?.substring(0, 50)}...</span></td>
                    <td>
                        <button class="button is-small is-outlined is-primary" onclick="alert('Full User Agent: ${alert.userAgent || 'Unknown'}')">
                            <span class="icon"><i class="fas fa-search"></i></span>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error("Error loading alerts:", error);
            document.getElementById('alertsTableBody').innerHTML = 
                '<tr><td colspan="5" class="has-text-centered has-text-danger">Error loading alerts. Please check console.</td></tr>';
        }
    }

    // Load alerts on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAlerts();
        setInterval(loadAlerts, 30000);
    });
</script>
